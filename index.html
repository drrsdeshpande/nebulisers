<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Nebuliser Position – v16 Enhanced PDF</title>
<script src="https://cdn.tailwindcss.com"></script>
<!-- Load jsPDF and AutoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

<style>
  body {
    background: #f4f4f5;
    color: #18181b;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Inter", "Helvetica Neue", sans-serif;
    min-height: 100vh;
  }
  .panel {
    background: #ffffff;
    border-radius: 1.5rem;
    padding: 1.5rem;
    box-shadow: 0 10px 25px rgba(0,0,0,0.05), 0 4px 10px rgba(0,0,0,0.02);
  }
  #circuitCanvas {
    background: #fcfcfc;
    border-radius: 1rem;
    border: 1px solid #e4e4e7;
    width: 100%;
    height: auto;
  }
  .control-button {
    padding: 0.6rem 0.2rem;
    text-align: center;
    font-size: 0.75rem;
    font-weight: 500;
    color: #52525b;
    background: #f4f4f5;
    border-radius: 0.6rem;
    border: 1px solid transparent;
    transition: all 0.2s;
    cursor: pointer;
  }
  .control-button:hover { background: #e4e4e7; color: #18181b; }
  .control-button.active {
    background: #ffffff;
    color: #0ea5e9;
    font-weight: 600;
    border-color: #e2e8f0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    transform: translateY(-1px);
  }
  .control-label {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #71717a;
    margin-bottom: 0.4rem;
    display: block;
  }
  .control-section { margin-bottom: 1.25rem; }
  .status-box {
    background: #f0f9ff;
    border: 1px solid #e0f2fe;
    border-radius: 0.75rem;
    padding: 0.75rem 1rem;
    font-size: 0.875rem;
    color: #0c4a6e;
    line-height: 1.5;
  }
  .download-button {
    width: 100%;
    padding: 0.75rem;
    border-radius: 0.75rem;
    background: #18181b;
    color: white;
    font-weight: 500;
    margin-top: 1rem;
    transition: all 0.2s;
  }
  .download-button:hover { background: #27272a; transform: translateY(-1px); }
</style>
</head>
<body class="p-4 md:p-8">
<div class="max-w-7xl mx-auto space-y-6">

  <div class="flex justify-between items-end">
    <h1 class="text-3xl md:text-4xl font-bold text-zinc-900 tracking-tight">Nebuliser Position &amp; Humidification</h1>
    <span class="text-xs text-zinc-400 font-medium hidden md:block">Comparative Analysis (Mesh, Jet, Ultrasonic)</span>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

    <!-- Controls -->
    <div class="panel lg:col-span-4 space-y-4">
      
      <div class="control-section">
        <label class="control-label">Humidifier (Heated Wire)</label>
        <div class="control-group grid grid-cols-2 gap-2" data-group="humidifier">
          <button class="control-button" data-value="on">ON (Wet Circuit)</button>
          <button class="control-button" data-value="off">OFF (Dry Circuit)</button>
        </div>
      </div>

      <div class="control-section">
        <label class="control-label">Patient Model</label>
        <div class="control-group grid grid-cols-2 gap-2" data-group="patientType">
          <button class="control-button" data-value="adult">Adult</button>
          <button class="control-button" data-value="pediatric">Pediatric</button>
        </div>
      </div>

      <div class="control-section">
        <label class="control-label">Nebuliser Position</label>
        <div class="control-group grid grid-cols-2 gap-2" data-group="nebPos">
          <button class="control-button" data-value="preHumid">Proximal (Reservoir)</button>
          <button class="control-button" data-value="yPiece">Distal (Y-Piece)</button>
        </div>
      </div>

      <div class="control-section">
        <label class="control-label">Nebuliser Type</label>
        <div class="control-group grid grid-cols-3 gap-2" data-group="nebType">
          <button class="control-button" data-value="vmn">VMN (Mesh)</button>
          <button class="control-button" data-value="jet">JN (Jet)</button>
          <button class="control-button" data-value="usn">USN (Ultrasonic)</button>
        </div>
      </div>

      <div class="control-section">
        <label class="control-label">Bias Flow</label>
        <div class="control-group grid grid-cols-2 gap-2" data-group="biasFlow">
          <button class="control-button" data-value="2">2 L/min (Low)</button>
          <button class="control-button" data-value="5">5 L/min (High)</button>
        </div>
      </div>

      <div id="leftStatus" class="status-box !mt-6">Status: Initializing…</div>
      <button id="downloadPdfButton" class="download-button">Download Comparative Data PDF</button>
    </div>

    <!-- Simulation Canvas -->
    <div class="panel lg:col-span-8 p-4 relative">
      <canvas id="circuitCanvas" width="1100" height="650"></canvas>
      <!-- Overlay for Deposition -->
      <div id="depositionLabel" class="absolute bottom-8 right-8 text-right">
        <div class="text-4xl font-bold text-zinc-800" id="depValue">0.0%</div>
        <div class="text-sm text-zinc-500">Inhaled Dose (Est. % of Total)</div>
      </div>
    </div>

  </div>
</div>

<script>
// *** SIMULATION ENGINE v16 (Enhanced PDF Content) ***

const canvas = document.getElementById("circuitCanvas");
const ctx = canvas.getContext("2d");
let animationRunning = false;
let particles = [];
let breathPhase = 0; // 0 = insp, 1 = exp
let phaseTimer = 0;

// Initial State
const simState = { 
  nebPos: 'preHumid', 
  nebType: 'vmn', 
  biasFlow: '2', 
  patientType: 'adult',
  humidifier: 'on' 
};

const colors = { 
  text: '#18181b', 
  vent: '#cbd5e1', 
  tube: '#e2e8f0', 
  humidifierBody: '#64748b',
  humidifierWater: '#38bdf8',
  inspActive: '#3b82f6', 
  inspStatic: '#93c5fd', 
  expActive: '#22c55e', 
  expStatic: '#86efac', 
  yPiece: '#a855f7', 
  lung: '#f43f5e', 
  nebGlow: '#0ea5e9' 
};

// --- POLYFILL for roundRect (Fixes Script Error) ---
CanvasRenderingContext2D.prototype.roundRect = CanvasRenderingContext2D.prototype.roundRect || function (x, y, w, h, r) {
  if (w < 2 * r) r = w / 2;
  if (h < 2 * r) r = h / 2;
  this.beginPath();
  this.moveTo(x+r, y);
  this.arcTo(x+w, y,   x+w, y+h, r);
  this.arcTo(x+w, y+h, x,   y+h, r);
  this.arcTo(x,   y+h, x,   y,   r);
  this.arcTo(x,   y,   x+w, y,   r);
  this.closePath();
  return this;
};

// --- WAYPOINTS ---
function getPath() {
  if (simState.humidifier === 'on') {
    return {
      insp: [
        { x: 160, y: 330 }, // 0: Vent
        { x: 380, y: 330 }, // 1: Humidifier Inlet
        { x: 450, y: 360 }, // 2: Humidifier Chamber (Deep)
        { x: 520, y: 330 }, // 3: Humidifier Outlet
        { x: 740, y: 330 }, // 4: Y-Piece
        { x: 880, y: 380 }, // 5: ET
        { x: 950, y: 450 }  // 6: Lung
      ],
      exp: [
        { x: 740, y: 330 }, 
        { x: 500, y: 150 }, 
        { x: 160, y: 150 }
      ]
    };
  } else {
    return {
      insp: [
        { x: 160, y: 330 },
        { x: 740, y: 330 },
        { x: 880, y: 380 },
        { x: 950, y: 450 }
      ],
      exp: [
        { x: 740, y: 330 }, 
        { x: 500, y: 150 }, 
        { x: 160, y: 150 }
      ]
    };
  }
}

// --- DEPOSITION LOGIC (Consensus Model) ---
function calculateDeposition() {
    const { nebType, nebPos, biasFlow, patientType, humidifier } = simState;
    
    let baseDeposition = 0; 

    // 1. Establish Nebuliser Baseline
    if (nebType === 'vmn') baseDeposition = 18; 
    else if (nebType === 'jet') baseDeposition = 5;  
    else if (nebType === 'usn') baseDeposition = 8;  
    
    let deposition = baseDeposition;

    // 2. Apply Placement
    if (nebType === 'jet') {
        if (nebPos === 'preHumid') deposition *= 1.2; 
        else deposition *= 0.8; 
    } else { 
        if (nebPos === 'preHumid') deposition *= 0.75; 
        else deposition *= 1.1; 
    }

    // 3. Apply Bias Flow Penalty (Washout)
    if (biasFlow === '5') deposition *= 0.7; 

    // 4. Apply Humidifier Effect 
    if (humidifier === 'off') {
        deposition *= 1.4; // 40% increase for dry circuit
    }
    
    // 5. Apply Pediatric Penalty 
    if (patientType === 'pediatric') deposition *= 0.7; 

    return Math.min(Math.round(deposition * 10) / 10, 40.0);
}

// --- UI / Control Functions ---
function updateText() {
  const val = calculateDeposition();
  document.getElementById("depValue").innerText = val.toFixed(1) + "%";
  
  let status = "";
  if (simState.humidifier === 'on') {
    status = "<b>Humidifier ON:</b> Humidity reduces overall delivery via particle growth (rain-out).";
  } else {
    status = "<b>Humidifier OFF:</b> Maximum theoretical delivery (dry circuit).";
  }

  if (simState.nebType === 'jet' && simState.nebPos === 'preHumid') {
    status += " <br>Optimizing Jet Nebuliser Reservoir Effect.";
  } else if (simState.nebType !== 'jet' && simState.nebPos === 'yPiece') {
    status += " <br>Optimizing Mesh/USN Distal Placement (min. tubing loss).";
  }
  
  if (simState.biasFlow === '5') status += " <span class='text-red-600 font-bold'>High Bias Flow (Washout Active!).</span>";
  
  document.getElementById("leftStatus").innerHTML = status;
}

function setupControls() {
  document.querySelectorAll(".control-group").forEach(group => {
    group.addEventListener("click", (e) => {
      const btn = e.target.closest(".control-button");
      if (!btn) return;
      simState[group.dataset.group] = btn.dataset.value;
      group.querySelectorAll(".control-button").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      phaseTimer = 0; 
      breathPhase = 0; 
      particles = []; 
      updateText();
      // Restart animation here to ensure new particles load
      startAnimation(); 
    });
    const initialBtn = group.querySelector(`[data-value="${simState[group.dataset.group]}"]`);
    if (initialBtn) initialBtn.classList.add("active");
  });
  updateText();
}

// --- Drawing & Animation Functions ---

function moveTowards(p, target, speed) {
  const dx = target.x - p.x;
  const dy = target.y - p.y;
  const dist = Math.hypot(dx, dy);
  
  if (dist < speed) {
    p.x = target.x;
    p.y = target.y;
    return true; // Reached target
  } else {
    p.x += (dx / dist) * speed;
    p.y += (dy / dist) * speed;
    return false;
  }
}

function createParticle() {
  const count = simState.nebType === 'vmn' ? 2 : 1;
  
  let startX = (simState.nebPos === 'preHumid') ? 280 : 760;
  let startY = (simState.nebPos === 'preHumid') ? 330 : 340;

  for(let i=0; i<count; i++) {
    particles.push({
      x: startX,
      y: startY + (Math.random() * 10 - 5),
      life: 1.0,
      targetIndex: 0 
    });
  }
}

function drawCircuit() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.lineCap = "round"; ctx.lineJoin = "round"; ctx.font = "bold 14px sans-serif";

  const paths = getPath();

  // 1. Ventilator
  ctx.fillStyle = colors.vent; ctx.roundRect(40, 280, 120, 100, 10); ctx.fill();
  ctx.fillStyle = "#475569"; ctx.fillText("Ventilator", 60, 335);

  // 2. Inspiratory Limb Path drawing
  ctx.lineWidth = 24; ctx.strokeStyle = colors.tube;
  ctx.beginPath();
  ctx.moveTo(paths.insp[0].x, paths.insp[0].y);
  for(let i=1; i<paths.insp.length; i++) {
      if(i < paths.insp.length - 1) ctx.lineTo(paths.insp[i].x, paths.insp[i].y);
  }
  ctx.stroke();

  // 3. Humidifier Graphic (If ON)
  if (simState.humidifier === 'on') {
    ctx.fillStyle = colors.humidifierBody;
    ctx.fillRect(380, 290, 140, 100);
    ctx.fillStyle = colors.humidifierWater;
    ctx.fillRect(390, 340, 120, 40);
    ctx.fillStyle = "white"; ctx.fillText("Humidifier", 410, 320);
  } else {
     ctx.strokeStyle = colors.tube; ctx.lineWidth = 24;
     ctx.beginPath(); ctx.moveTo(300, 330); ctx.lineTo(600, 330); ctx.stroke();
  }

  // 4. Flow Indicators
  ctx.strokeStyle = (breathPhase === 0) ? colors.inspActive : colors.inspStatic;
  ctx.lineWidth = 4;
  ctx.beginPath();
  ctx.moveTo(paths.insp[0].x + 10, paths.insp[0].y);
  for(let i=1; i<paths.insp.length - 2; i++) {
      ctx.lineTo(paths.insp[i].x, paths.insp[i].y);
  }
  ctx.stroke();

  // 5. Y-Piece & Distal
  ctx.fillStyle = colors.yPiece; ctx.beginPath(); ctx.arc(740, 330, 25, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = "white"; ctx.fillText("Y", 735, 335);
  
  ctx.strokeStyle = "#fb7185"; ctx.lineWidth = 18;
  ctx.beginPath(); ctx.moveTo(760, 330); ctx.lineTo(880, 380); ctx.stroke();

  // 6. Lung
  ctx.fillStyle = colors.lung;
  const scale = simState.patientType === 'adult' ? 1 : 0.7;
  ctx.beginPath(); ctx.ellipse(950, 450, 80*scale, 100*scale, 0.2, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = "white"; ctx.fillText(simState.patientType.toUpperCase(), 920, 450);

  // 7. Expiratory Limb
  ctx.lineWidth = 24; ctx.strokeStyle = colors.tube;
  ctx.beginPath(); 
  ctx.moveTo(paths.exp[0].x, paths.exp[0].y - 10);
  ctx.lineTo(paths.exp[1].x, paths.exp[1].y); 
  ctx.lineTo(paths.exp[2].x, paths.exp[2].y); ctx.stroke();

  // Nebulizer
  let nebX = (simState.nebPos === 'preHumid') ? 280 : 750;
  let nebY = (simState.nebPos === 'preHumid') ? 330 : 340;
  
  ctx.fillStyle = colors.nebGlow; ctx.shadowBlur = 15; ctx.shadowColor = colors.nebGlow;
  ctx.beginPath(); ctx.arc(nebX, nebY, 15, 0, Math.PI*2); ctx.fill();
  ctx.shadowBlur = 0;
}

function animate() {
  // Use requestAnimationFrame to loop only if the function is still active
  if(!animationRunning) return; 

  phaseTimer++;
  const cycleLength = simState.patientType === 'adult' ? 240 : 150;
  if (phaseTimer > cycleLength) { breathPhase = (breathPhase + 1) % 2; phaseTimer = 0; }

  drawCircuit();
  createParticle();

  const paths = getPath();
  const inspPoints = paths.insp;
  const expPoints = paths.exp;

  // Speeds
  const speedInsp = 4.0;
  const speedBias = (simState.biasFlow === '2') ? 0.5 : 3.0;

  particles.forEach(p => {
    
    let target = null;
    let speed = 0;

    const inHumidifier = (simState.humidifier === 'on' && p.x > 380 && p.x < 520);
    
    if (breathPhase === 0) {
        // INSPIRATION: Move forward through inspNodes
        let targetIndex = 0;

        if (simState.humidifier === 'on') {
            if (p.x < 380) targetIndex = 1; 
            else if (p.x < 450) targetIndex = 2; // Deep chamber
            else if (p.x < 520) targetIndex = 3; // Outlet
            else if (p.x < 740) targetIndex = 4; // Y-Piece
            else if (p.x < 880) targetIndex = 5; // ET
            else targetIndex = 6; // Lung
        } else {
            if (p.x < 740) targetIndex = 1; // Y-Piece
            else if (p.x < 880) targetIndex = 2; // ET
            else targetIndex = 3; // Lung
        }

        target = inspPoints[targetIndex];
        speed = speedInsp;

    } else {
        // EXPIRATION (Bias Flow Washout)
        // Washout depends on particle location relative to Y-Piece (740, 330)
        
        if (p.x < 740) {
            // In Insp Limb -> Move forward with bias flow (Reservoir)
            target = {x: 740, y: 330};
            speed = speedBias;
        } else {
            // In Lung or Y-piece -> Washout to Exp Limb
            if (p.x > 500 && p.y > 200) target = expPoints[1]; // Knee
            else target = expPoints[2]; // Vent
            speed = (simState.biasFlow === '5') ? 4.0 : 2.0;
        }
    }

    // --- RAIN OUT LOGIC (Humidification Loss) ---
    if (inHumidifier && Math.random() < 0.05) {
        p.life -= 0.1; 
    }
    
    // --- MOVEMENT ---
    if (target) {
        if (moveTowards(p, target, speed)) {
             // Nudge past sticky points at the Y-Piece for smoother flow into Exp
             if (target.x === 740) {
                 p.x = 735;
                 if (breathPhase === 1) p.y = 325; // Nudge up into exp path
             }
        }
    }
    
    // --- LUNG ABSORPTION ---
    if (p.x > 900 && breathPhase === 0) p.life -= 0.1;

    // Render
    ctx.fillStyle = `rgba(37, 99, 235, ${p.life})`;
    if (simState.nebType === 'jet') ctx.fillStyle = `rgba(245, 158, 11, ${p.life})`; // Amber for Jet
    if (simState.nebType === 'usn') ctx.fillStyle = `rgba(139, 92, 246, ${p.life})`; // Violet for USN
    
    ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill();
  });

  particles = particles.filter(p => p.life > 0 && p.x > 100);
  requestAnimationFrame(animate);
}

function startAnimation(){
  // Stop existing animation loop if any
  animationRunning = false; 
  particles = [];
  breathPhase = 0;
  phaseTimer = 0;
  
  createParticle();
  
  animationRunning = true;
  requestAnimationFrame(animate);
}

// --- PDF Generation Function (The reliable version) ---
function generatePDF() {
    // CRITICAL CHECK: Ensure jsPDF library is available
    if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
        console.error("PDF generation failed: jsPDF library not fully loaded.");
        // Use a simple alert, as custom modals are not allowed for this error context.
        alert("PDF generator not ready yet. Please try clicking the button again in a moment.");
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'pt', 'a4');

    // --- PDF Styling ---
    const marginX = 40;
    let cursorY = 40;
    const pageWidth = doc.internal.pageSize.getWidth();
    const usableWidth = pageWidth - marginX * 2;
    const colorPrimary = [59, 130, 246]; // blue-500
    const colorSecondary = [244, 63, 94]; // rose-500
    const colorAccent = [139, 92, 246]; // violet-500

    function drawHeading(text, size, color) {
      doc.setFont("helvetica", "bold");
      doc.setFontSize(size);
      doc.setTextColor(color[0], color[1], color[2]);
      cursorY += (size + 5);
      doc.text(text, marginX, cursorY);
      doc.setTextColor(0, 0, 0); 
      cursorY += 5;
    }
    
    function drawText(text, size = 10, style = "normal", indent = 0) {
      doc.setFont("helvetica", style);
      doc.setFontSize(size);
      const splitText = doc.splitTextToSize(text, usableWidth - indent);
      cursorY += 5;
      doc.text(splitText, marginX + indent, cursorY);
      cursorY += (splitText.length * (size + 2));
    }

    function drawBullet(text) {
        // Use "text" for markdown processing before passing to PDF
        drawText("• " + text.replace(/\*\*/g, '').replace(/\[([^\]]+)\]/g, '$1'), 10, "normal", 10);
    }
    
    // --- LAYOUT START ---

    // Title Block
    drawHeading("Comparative Effects of Nebulisers in Ventilated Adults", 18, [0, 0, 0]);
    drawText("Analysis comparing Jet, Vibrating Mesh, and Ultrasonic nebulisers, focusing on efficiency, position, and circuit effects.", 9, "italic");
    drawText("Data Sources: Ari et al. (2010), Lin HL et al. (2021), and related clinical guidelines.", 8, "normal");


    // --- SECTION 1: Deposition Efficiency ---
    drawHeading("1. Deposition Efficiency in the Lungs", 14, colorPrimary);
    
    drawText("Mechanically ventilated patients receive a smaller fraction of the nebulised drug in the lungs. Efficiency depends heavily on particle size and output mechanism:", 10);
    
    drawBullet("Vibrating Mesh Nebulisers (VMN) are the most efficient, achieving 12–35% deposition in optimized settings. Their fine particle size (3–5 µm) and minimal drug waste drive this high performance.");
    drawBullet("Ultrasonic Nebulisers (USN) are moderately efficient, typically delivering 5–10% of the dose. Their higher output and intermediate particle size contribute to improved delivery over jets.");
    drawBullet("Jet Nebulisers (JN) are the least efficient, often delivering only ~3–5% of the dose under typical ventilator conditions, due to heterodisperse particles and high residual volume.");


    // --- SECTION 2: Impact of Humidification and Flow ---
    drawHeading("2. Humidification and Bias Flow Impact", 14, colorSecondary);
    
    drawText("Active humidification causes aerosol particles to grow and deposit prematurely, leading to up to a 50% reduction in delivery. In contrast, bias flow affects aerosol availability:", 10);
    
    drawBullet("High Bias Flow (5 L/min) creates a Washout Effect, flushing aerosol into the expiratory limb during exhalation, significantly reducing the available dose for the next inspiration.");
    drawBullet("Low Bias Flow (2 L/min) minimizes washout, which is essential for maximizing both distal and proximal placements.");
    drawText("Crucially, HME filters must be removed or bypassed during nebulisation, as they can trap over 90% of the dose.", 10, "bold");


    // --- SECTION 3: Optimal Placement and The Reservoir Effect ---
    drawHeading("3. Optimal Nebuliser Placement", 14, colorAccent);

    drawText("Placement strategy is determined by the nebuliser's output mechanism:", 10);
    
    drawBullet("Jet Nebulisers (JN) perform best when placed Proximal (upstream, near the ventilator). Their continuous output fills the long inspiratory tubing during exhalation, creating a reservoir that is inhaled on the next breath.");
    drawBullet("VMN & USN perform best when placed Distal (close to the Y-Piece). Because these devices do not add continuous flow, minimal tubing length is preferred to reduce simple circuit deposition loss.");

    // --- ANSWER TO VMN RESERVOIR QUESTION ---
    drawHeading("Why the Reservoir Effect Does NOT Primarily Benefit VMN", 12, colorPrimary);
    drawText("The Reservoir Effect (where the inspiratory tubing stores aerosol between breaths) is less effective for the VMN compared to the JN for two main reasons:", 10, "bold");
    
    drawBullet("VMN does not add flow. The aerosol produced by a VMN tends to stay localized near the device until the ventilator breath pulls it forward. When placed proximally, the aerosol bolus must travel through the entire circuit volume, increasing the time available for gravitational sedimentation (particles falling out) before reaching the patient.");
    drawBullet("JN's continuous gas output actively pushes aerosol into the tubing, ensuring the entire limb is 'charged' with a higher density of medication, making it a true functional reservoir. The VMN lacks this active pushing mechanism.");
    drawText("Therefore, the VMN relies on minimizing circuit length (Distal placement) to maximize deposition, while the JN relies on maximizing reservoir volume (Proximal placement) to maximize efficiency.", 10);

    // --- SECTION 4: Comparative Summary Table ---
    cursorY = doc.autoTable.previous ? doc.autoTable.previous.finalY + 15 : cursorY + 15;
    drawHeading("4. Comparative Summary Table", 14, colorSecondary);

    const tableData = {
      head: [['Feature', 'Jet Nebuliser (JN)', 'Vibrating Mesh (VMN)', 'Ultrasonic (USN)']],
      body: [
        ['Deposition (% of dose)', 'Low: ~3–5%', 'Highest: ~12–35%', 'Moderate: ~5–10%'],
        ['Optimal Placement', 'Upstream (Proximal/Reservoir)', 'Downstream (Distal/Y-Piece)', 'Downstream (Distal/Y-Piece)'],
        ['Flow Interference', 'High (Adds 6–8 L/min)', 'None (Electric)', 'None (Electric)'],
        ['Residual Volume / Waste', 'High (~1 mL)', 'Minimal (<0.5 mL)', 'Moderate'],
        ['Cost', 'Low (Inexpensive)', 'High (Expensive Equipment)', 'High (Bulky Equipment)'],
      ]
    };
    
    doc.autoTable({
      startY: cursorY + 5,
      head: tableData.head,
      body: tableData.body,
      theme: 'striped',
      headStyles: { fillColor: [59, 130, 246] }, // blue-500
      styles: { fontSize: 9, cellPadding: 4, overflow: 'linebreak' },
      margin: { top: 20, left: marginX, right: marginX },
    });

    doc.save("nebuliser_comparative_report.pdf");
  }
// --- END PDF GENERATION FUNCTION ---


window.onload = function() {
  // Ensure DOM elements are ready before starting animation/controls
  animationRunning = true;
  setupControls();
  startAnimation();

  // Attach the PDF listener only after everything else is initialized
  document.getElementById('downloadPdfButton').addEventListener('click', generatePDF);
};
</script>
</body>
</html>
